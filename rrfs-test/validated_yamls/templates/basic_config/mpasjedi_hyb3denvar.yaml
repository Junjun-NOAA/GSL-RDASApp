_member: &memberConfig
  date: &analysisDate '@analysisDate@'
  state variables: &incvars [water_vapor_mixing_ratio_wrt_moist_air, air_pressure_at_surface, air_temperature, northward_wind, eastward_wind]
  stream name: ensemble

output:
  filename: mpasin.nc
  stream name: analysis
variational:
  minimizer:
    algorithm: DRPCG
  iterations:
  - geometry:
      nml_file: ./namelist.atmosphere
      streams_file: ./streams.atmosphere
      deallocate non-da fields: true
      interpolation type: unstructured
    gradient norm reduction: 1e-3
    ninner: 50
  - geometry:
      nml_file: ./namelist.atmosphere
      streams_file: ./streams.atmosphere
      deallocate non-da fields: true
      interpolation type: unstructured
    gradient norm reduction: 1e-3
    ninner: 50
cost function:
  cost type: 3D-Var
  time window:
     begin: '@beginDate@'
     length: PT4H
  jb evaluation: false
  geometry:
    nml_file: ./namelist.atmosphere
    streams_file: ./streams.atmosphere
    deallocate non-da fields: true
    interpolation type: unstructured
  analysis variables: *incvars
  background:
    state variables:
    - water_vapor_mixing_ratio_wrt_moist_air
    - air_pressure_at_surface
    - air_temperature
    - northward_wind
    - eastward_wind
    - air_potential_temperature
    - dry_air_density
    - u
    - water_vapor_mixing_ratio_wrt_dry_air
    - air_pressure
    - landmask
    - seaice_fraction
    - snowc
    - skin_temperature_at_surface
    - ivgtyp
    - isltyp
    - snowh
    - vegetation_area_fraction
    - eastward_wind_at_10m
    - northward_wind_at_10m
    - lai
    - smois
    - tslb
    - pressure_p
    - cloud_liquid_water
    - cloud_liquid_ice
    - graupel
    - rain_water
    - snow_water
    - cldfrac
    filename: mpasin.nc
    date: *analysisDate
  background error:
    covariance model: hybrid
    components:
    - covariance:
        covariance model: SABER
        saber central block:
          saber block name: BUMP_NICAS
          active variables: &ctlvars
          - air_horizontal_streamfunction
          - air_horizontal_velocity_potential
          - air_temperature
          - water_vapor_mixing_ratio_wrt_moist_air
          - air_pressure_at_surface
          read:
            io:
              data directory: data/static_bec/nicas
              files prefix: mpas
            drivers:
              multivariate strategy: univariate
              read local nicas: true
        saber outer blocks:
        - saber block name: StdDev
          read:
            model file:
              filename: data/static_bec/stddev.nc
              date: *analysisDate
              stream name: control
        - saber block name: BUMP_VerticalBalance
          read:
            io:
              data directory: data/static_bec/vbal
              files prefix: mpas_vbal
            drivers:
              read local sampling: true
              read vertical balance: true
            vertical balance:
              vbal:
              - balanced variable: air_horizontal_velocity_potential
                unbalanced variable: air_horizontal_streamfunction
                diagonal regression: true
              - balanced variable: air_temperature
                unbalanced variable: air_horizontal_streamfunction
              - balanced variable: air_pressure_at_surface
                unbalanced variable: air_horizontal_streamfunction
        linear variable change:
          linear variable change name: Control2Analysis
          input variables: *ctlvars
          output variables: *incvars
      weight:
        value: "@HYB_WGT_STATIC@"
    - covariance:
        covariance model: ensemble
        localization:
          localization method: SABER
          saber central block:
            saber block name: BUMP_NICAS
            active variables: *incvars
            read:
              io:
                data directory: data/bumploc
                files prefix: bumploc
              drivers:
                multivariate strategy: duplicated
                read local nicas: true
              model:
                level for 2d variables: last
        members from template:
          template:
            <<: *memberConfig
            filename: ./data/ens/mem%iMember%.nc
          pattern: "%iMember%"
          start: 1
          zero padding: 3
          nmembers: 30
      weight:
        value: "@HYB_WGT_ENS@"
  observations:
     observers:
        "@OBSERVATIONS@"
